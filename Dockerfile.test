# Test environment for learning-agent
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    unzip \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install Deno (required for sandbox execution)
RUN curl -fsSL https://deno.land/install.sh | sh
ENV PATH="/root/.deno/bin:${PATH}"

# Copy dependency files
COPY pyproject.toml .
COPY README.md .

# Copy source and tests
COPY src/ ./src/
COPY tests/ ./tests/
COPY langgraph.json .
COPY constraints.txt .

# Install the package with all dev dependencies using uv
RUN pip install --no-cache-dir uv && \
    uv pip install --system --constraint constraints.txt -e ".[dev]"

# Install langgraph-cli for server functionality
RUN uv pip install --system "langgraph-cli[inmem]"

# Verify langchain-sandbox is from GitHub (version should be 0.0.7+, not 0.0.1 from PyPI)
RUN python -c "import langchain_sandbox; import sys; version = getattr(langchain_sandbox, '__version__', 'unknown'); print(f'langchain-sandbox version: {version}'); sys.exit(1 if version == '0.0.1' else 0)" && \
    echo "✅ langchain-sandbox correctly installed from GitHub"

# Download and prepare TypeScript source from GitHub to avoid JSR dependencies
RUN mkdir -p /tmp/langchain-sandbox-ts && \
    curl -s -o /tmp/langchain-sandbox-ts/pyodide_sandbox.ts \
    https://raw.githubusercontent.com/johannhartmann/langchain-sandbox/main/libs/pyodide-sandbox-js/main.ts && \
    # Replace JSR imports with Deno.land URLs
    sed -i 's|import { join } from "@std/path";|import { join } from "https://deno.land/std@0.224.0/path/mod.ts";|' \
        /tmp/langchain-sandbox-ts/pyodide_sandbox.ts && \
    sed -i 's|import { parseArgs } from "@std/cli/parse-args";|import { parseArgs } from "https://deno.land/std@0.224.0/cli/parse_args.ts";|' \
        /tmp/langchain-sandbox-ts/pyodide_sandbox.ts && \
    # Fix pyodide import
    sed -i 's|import { loadPyodide } from "pyodide";|import { loadPyodide } from "npm:pyodide@0.26.4";|' \
        /tmp/langchain-sandbox-ts/pyodide_sandbox.ts && \
    echo "✅ TypeScript source prepared from GitHub"

# Set environment variable to use our prepared TypeScript source
ENV LANGCHAIN_SANDBOX_TS_SOURCE=/tmp/langchain-sandbox-ts/pyodide_sandbox.ts

# Set environment variables for testing
ENV PYTHONUNBUFFERED=1
ENV DOCKER_ENV=1
ENV PYTEST_ADDOPTS="-v --tb=short"

# Default command runs all tests
CMD ["python", "-m", "pytest", "tests/", "-v"]
